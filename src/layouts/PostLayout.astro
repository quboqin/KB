---
import BaseLayout from './BaseLayout.astro';
import TOC from '@/components/blog/TOC.astro';
import ReadingProgress from '@/components/blog/ReadingProgress.astro';
import RelatedPosts from '@/components/blog/RelatedPosts.astro';
import GiscusComments from '@/components/widgets/GiscusComments.astro';
import { formatDate } from '@/utils/date';
import type { CollectionEntry } from 'astro:content';

interface Props {
  post: CollectionEntry<'posts'>;
  headings: { depth: number; slug: string; text: string }[];
  relatedPosts: CollectionEntry<'posts'>[];
}

const { post, headings, relatedPosts } = Astro.props;
const { title, description, pubDate, updatedDate, heroImage, tags } = post.data;
---

<BaseLayout title={title} description={description} image={heroImage}>
  <ReadingProgress />

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="lg:grid lg:grid-cols-[1fr_280px] lg:gap-12">
      <!-- Main content -->
      <article id="article-content">
        {heroImage && (
          <div class="mb-8 rounded-2xl overflow-hidden aspect-video">
            <img src={heroImage} alt={title} class="w-full h-full object-cover" />
          </div>
        )}

        <header class="mb-8">
          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
              {tags.map(tag => (
                <a href={`/tags/${tag}`}
                   class="text-xs font-medium px-3 py-1 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors">
                  #{tag}
                </a>
              ))}
            </div>
          )}

          <h1 class="text-3xl sm:text-4xl font-medium text-slate-900 dark:text-white leading-tight mb-4">
            {title}
          </h1>

          <div class="flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400">
            <time datetime={pubDate.toISOString()}>{formatDate(pubDate)}</time>
            {updatedDate && updatedDate > pubDate && (
              <span>· 更新于 {formatDate(updatedDate)}</span>
            )}
          </div>
        </header>

        <!-- Article body -->
        <div class="prose prose-slate dark:prose-invert prose-lg max-w-none
                    prose-headings:font-medium prose-headings:tracking-tight
                    prose-a:text-indigo-600 dark:prose-a:text-indigo-400
                    prose-code:text-indigo-600 dark:prose-code:text-indigo-400
                    prose-code:bg-slate-100 dark:prose-code:bg-slate-800
                    prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:font-normal
                    prose-pre:bg-slate-900 dark:prose-pre:bg-slate-950">
          <slot />
        </div>
      </article>

      <!-- Sidebar TOC (desktop only) -->
      <aside class="hidden lg:block">
        <div class="sticky top-24">
          {headings.length > 0 && <TOC headings={headings} />}
        </div>
      </aside>
    </div>

    {relatedPosts.length > 0 && <RelatedPosts posts={relatedPosts} />}

    <GiscusComments />
  </div>
</BaseLayout>

<script>
  import mermaid from 'mermaid';

  function initMermaid() {
    const isDark = document.documentElement.classList.contains('dark');
    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? 'dark' : 'default',
      securityLevel: 'loose',
    });

    const blocks = document.querySelectorAll<HTMLElement>('pre code.language-mermaid');
    blocks.forEach(async (code) => {
      const pre = code.parentElement!;
      const definition = code.textContent ?? '';
      const id = `mermaid-${Math.random().toString(36).slice(2, 9)}`;

      const wrapper = document.createElement('div');
      wrapper.className = 'mermaid-diagram my-6 flex justify-center overflow-x-auto';

      try {
        const { svg } = await mermaid.render(id, definition);
        wrapper.innerHTML = svg;
      } catch {
        wrapper.textContent = definition;
      }

      pre.replaceWith(wrapper);
    });
  }

  // Init on load and re-run if dark mode toggles
  initMermaid();
  new MutationObserver(() => {
    document.querySelectorAll('.mermaid-diagram').forEach(el => el.remove());
    // Re-render not needed after toggle — theme change re-initializes on next page load
  }).observe(document.documentElement, { attributeFilter: ['class'] });
</script>
